Index: build_dir/target/linux/ar71xx/files/arch/mips/ath79/mach-wpj558.c
===================================================================
--- build_dir.orig/target/linux/ar71xx/files/arch/mips/ath79/mach-wpj558.c
+++ build_dir/target/linux/ar71xx/files/arch/mips/ath79/mach-wpj558.c
@@ -55,27 +55,27 @@
 
 static struct gpio_led wpj558_leds_gpio[] __initdata = {
 	{
-		.name		= "wpj558:red:sig1",
+		.name		= "wpj344:red:sig1",
 		.gpio		= WPJ558_GPIO_LED_SIG1,
 		.active_low	= 1,
 	},
 	{
-		.name		= "wpj558:yellow:sig2",
+		.name		= "wpj344:yellow:sig2",
 		.gpio		= WPJ558_GPIO_LED_SIG2,
 		.active_low	= 1,
 	},
 	{
-		.name		= "wpj558:green:sig3",
+		.name		= "wpj344:green:sig3",
 		.gpio		= WPJ558_GPIO_LED_SIG3,
 		.active_low	= 1,
 	},
 	{
-		.name		= "wpj558:green:sig4",
+		.name		= "wpj344:green:sig4",
 		.gpio		= WPJ558_GPIO_LED_SIG4,
 		.active_low	= 1,
 	},
 	{
-		.name		= "wpj558:buzzer",
+		.name		= "wpj344:buzzer",
 		.gpio		= WPJ558_GPIO_BUZZER,
 		.active_low	= 0,
 	}
@@ -105,6 +105,14 @@ static struct ar8327_pad_cfg wpj558_ar83
 	.rxclk_delay_sel = AR8327_CLK_DELAY_SEL2,
 };
 
+static struct ar8327_led_cfg wpj558_ar8327_led_cfg = {
+	.led_ctrl0 = 0xc737c737,
+	.led_ctrl1 = 0xc737c737,
+	.led_ctrl2 = 0xc737c737,
+	.led_ctrl3 = 0x3ffff000,
+	.open_drain = true,
+};
+
 static struct ar8327_platform_data wpj558_ar8327_data = {
 	.pad0_cfg = &wpj558_ar8327_pad0_cfg,
 	.pad6_cfg = &wpj558_ar8327_pad6_cfg,
@@ -122,6 +130,7 @@ static struct ar8327_platform_data wpj55
 		.txpause = 1,
 		.rxpause = 1,
 	},
+	.led_cfg = &wpj558_ar8327_led_cfg,
 };
 
 static struct mdio_board_info wpj558_mdio0_info[] = {
@@ -132,10 +141,13 @@ static struct mdio_board_info wpj558_mdi
 	},
 };
 
+extern u8 *ath10k_macaddr;
+
 static void __init wpj558_setup(void)
 {
+        struct ath9k_platform_data *pdata;
+	u8 mac[ETH_ALEN];
 	u8 *art = (u8 *) KSEG1ADDR(0x1fff0000);
-	u8 *mac = (u8 *) KSEG1ADDR(0x1f02e000);
 
 	ath79_register_m25p80(NULL);
 	ath79_register_leds_gpio(-1, ARRAY_SIZE(wpj558_leds_gpio),
@@ -146,15 +158,23 @@ static void __init wpj558_setup(void)
 
 	ath79_register_usb();
 
-	ath79_register_wmac(art + WPJ558_WMAC_CALDATA_OFFSET, NULL);
-
-	ath79_register_pci();
+	/* Reserve one for LAN */
+        ath79_init_mac(mac, (u8 *) KSEG1ADDR(0x1f02e010), 3);
+        ath79_register_wmac(art + WPJ558_WMAC_CALDATA_OFFSET, mac);
+        ath79_init_mac(mac, (u8 *) KSEG1ADDR(0x1f02e010), 2);
+	ath10k_macaddr = kmalloc(ETH_ALEN, GFP_KERNEL);
+	memcpy(ath10k_macaddr, mac, ETH_ALEN);
+	ap91_pci_init(NULL, mac);
+        pdata = ap9x_pci_get_wmac_data(0);
+        if (pdata) {
+        	pdata->use_eeprom = true;
+	}
 
 	mdiobus_register_board_info(wpj558_mdio0_info,
 					ARRAY_SIZE(wpj558_mdio0_info));
 	ath79_register_mdio(0, 0x0);
 
-	ath79_init_mac(ath79_eth0_data.mac_addr, mac + WPJ558_MAC_OFFSET, 0);
+	ath79_init_mac(ath79_eth0_data.mac_addr, (u8 *) KSEG1ADDR(0x1f02e010), 0);
 
 	ath79_setup_qca955x_eth_cfg(QCA955X_ETH_CFG_RGMII_EN);
 
