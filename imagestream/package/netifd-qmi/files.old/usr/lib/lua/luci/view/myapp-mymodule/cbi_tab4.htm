<%+header%>

<script type="text/javascript" src="<%=resource%>/xhr.js"></script>
<script type="text/javascript">//<![CDATA[

	reading = 0;
	indx = -1;
	index = [];
	recread = [];
	number = [];
	tdate = [];
	ttime = [];
	ttext =[];
	selectline = -1;

	XHR.poll(4, '<%=luci.dispatcher.build_url("admin", "modem", "check_read")%>', null,
		function(x, rv)
		{
			var ss = rv.ready;
			if ( ss == "2" )
			{
				reading = 2;
				clearListBox("smsList");
				document.getElementById('message').innerHTML="";
				document.getElementById('total').innerHTML="";
				document.getElementById('used').innerHTML="";
			}
			else
			{
				reading = 0;
			}
			if ( reading == 0 )
			{
				clearListBox("smsList");
				var s = rv.ready;
				if ( s == "1" )
				{
					var line=rv.line;
   					var arr=(line.split("|"));  
					var len = arr.length;
					indx = 0;
					var i;
					for(i=0;i<len;i++)
					{
						var t = arr[i];
						var cpms = t.indexOf("+CPMS:");
						if ( cpms == 0 )
						{
							var tmp = t.split("MS:");
							var nmsg = tmp[1].split(",");
							document.getElementById('total').innerHTML=nmsg[1];
							document.getElementById('used').innerHTML=nmsg[0];
						}
						var cmgl = t.indexOf("+CMGR:");
						if ( cmgl == 0 )
						{
							var tmp = t.split("GR: ");
							var tmsg = tmp[1].split(",");
							index[indx] = indx;
							tmsg[0] = tmsg[0].replace(/\"/g,"");
							recread[indx] = "** ";
							if ( tmsg[0] == "1" )
							{
								recread[indx] = "   ";
							}
							if ( tmsg[0] <=1 )
							{
								var pdu = arr[i + 1];
								var SCAddressLength = GetByte(pdu);
								pdu = pdu.substr(2);
								var SCAddressType = GetByte(pdu);
								pdu = pdu.substr(2);
								var sttr = pdu.substr(0, (SCAddressLength - 1) * 2);
        							var SCAddressValue = GetAddress(sttr);
								pdu = pdu.substr((SCAddressLength - 1) * 2);
								var FirstOctet = GetByte(pdu);
								pdu = pdu.substr(2);
        							var SrcAddressLength = GetByte(pdu);
								pdu = pdu.substr(2);
        							var SrcAddressType = GetByte(pdu);
								pdu = pdu.substr(2);
        							SrcAddressLength += SrcAddressLength % 2;
								sttr = pdu.substr(0, SrcAddressLength);
        							var SrcAddressValue = GetAddress(sttr);
								number[indx] = SrcAddressValue;
								pdu = pdu.substr(SrcAddressLength);
								var TP_PID = GetByte(pdu);
								pdu = pdu.substr(2);
        							var TP_DCS = GetByte(pdu);
								pdu = pdu.substr(2);
								sttr = pdu.substr(0, 14);
								var TP_SCTS = GetDate(sttr);
								pdu = pdu.substr(14);
								var TP_UDL = GetByte(pdu);
								pdu = pdu.substr(2);
								ttext[indx] = Decode(TP_DCS, TP_UDL, FirstOctet, pdu);
								//ttext[indx] = pdu;
								var ttxt = ttext[indx].substr(0, 20);
								var txtline = number[indx].concat("                      ");
								txtline = txtline.substr(0, 20);
								txtline = recread[indx].concat(txtline);
								txtline = txtline.concat(TP_SCTS);
								txtline = txtline.concat(" ");
								txtline = txtline.concat(ttxt);
								txtline = txtline.concat(" ...");
								txtline = txtline.replace(/ /g,"\240");

								var select = document.getElementById("smsList");
                    						select.options[select.options.length] = new Option(txtline, indx);
								i = i + 1;
								indx = indx + 1;
							}
						}
					}
					if ( indx != -1 )
					{
						if ( selectline == -1 )
						{
							select.value = 0;
							document.getElementById('message').innerHTML=ttext[0];
							selectline = 0;
						}
						else
						{
							if ( selectline > indx-1 )
							{
								selectline = indx -1 ;
							}
							select.value = selectline;
							document.getElementById('message').innerHTML=ttext[selectline];
						}
					}
				}
			} 
		}
	); 

	document.getElementById('message').innerHTML=" ";
	document.getElementById('total').innerHTML="0";
	document.getElementById('used').innerHTML="0";

	function Swap(TwoChar)
	{
		var s = TwoChar.substr(1,1);
		s = s.concat(TwoChar.substr(0,1));
		return s;
	}

	function InvertHexString(HexString)
	{
		var result = "";
		var len = HexString.length;
		var i = len - 3;
		while (i >= 0 )
		{
			result = result.concat(HexString.substr(i, 2));
			i = i - 2;
		}
		return result;
	}

	function BytetoBinary(value)
	{
		var rval = value;
		var binary = "00000000";
		binary = binary.concat(rval.toString(2));
		binary = binary.substring(binary.length,binary.length-8)
		return binary;
	}

	function Decode(Bitcode, count, FOct, decode)
	{
		var result = "";
		var dcode = decode;
		var bit = (Bitcode & 64);
		var Binary = "";
		if ( bit != 0 )
		{
			return decode;
		}
		var UDHbit = (FOct & 64);
		if ( UDHbit != 0 )
		{
			var UDL = parseInt(dcode.substr(0, 2), 16);
			var UDH = dcode.substr(2, UDL * 2);
			dcode = dcode.substr(2 + (UDL * 2));
			var IEI = parseInt(UDH.substr(0,2), 16);
			if ( IEI == 0 )
			{
				var IEDL = parseInt(UDH.substr(2,2), 16);
				var REFN = parseInt(UDH.substr(4,2), 16);
				var MAXP = parseInt(UDH.substr(6,2), 16);
				var PART = parseInt(UDH.substr(8,2), 16);
				result = "Msg Ref#";
				result = result.concat(REFN.toString());
				result = result.concat(" Part ");
				result = result.concat(PART.toString());
				result = result.concat("/");
				result = result.concat(MAXP.toString());
				result = result.concat(" : ");
			}
		}

		bit = (Bitcode & 3);
		if ( bit == 0 || bit == 3 )
		{
			var Inv7BitCode = InvertHexString(dcode);
			var len = Inv7BitCode.length;
			var i;
			for (i=0;i<len-1;i++)
			{
				var str = Inv7BitCode.substr(i, 2);
				var rval = parseInt(str, 16);
				Binary = Binary.concat(BytetoBinary(rval));
				i = i + 1;
			}
			var blen = Binary.length;
			var temp;
			for(i=1;i<=count;i++)
			{
				temp = parseInt(Binary.substr(blen - i * 7, 7) ,2);
				result = result.concat(String.fromCharCode(temp));
			}
		}
		else
		{
			var len = dcode.length / 4;
			var i=0;
			for(i=0;i<len;i++)
			{
				var str = dcode.substr(i * 4, 4);
				var rval = String.fromCharCode(parseInt(str, 16));
				result = result.concat(rval);
			}
		}

		return result;
	}

	function GetDate(SCTS)
	{
		var year = Swap(SCTS.substr(0,2));
		var month = Swap(SCTS.substr(2,2));
		var day = Swap(SCTS.substr(4,2));
		var hour = Swap(SCTS.substr(6,2));
		var minute = Swap(SCTS.substr(8,2));
		var second = Swap(SCTS.substr(10,2));
		var zone = Swap(SCTS.substr(12,2));
		var date = year.concat("/");
		date = date.concat(month);
		date = date.concat("/");
		date = date.concat(day);
		date = date.concat("       ");
		date = date.substr(0, 9);
		date = date.concat(hour);
		date = date.concat(":");
		date = date.concat(minute);
		date = date.concat(":");
		date = date.concat(second);
		date = date.concat("-");
		date = date.concat(zone);
		date = date.concat(" ");
		return date;
	}

	function GetAddress(Address)
	{
		var tmp = Address;
		var len = tmp.length;
		var result = "";
		var i;
		for(i=0;i<len;i++)
		{
			var t = tmp.substr(i,2);
			result = result.concat(Swap(t));
			i = i + 1;
		}
		if ( result.indexOf("F") != -1 )
		{
			result = result.substr(0, result.length - 1);
		}
		return result;
	}

	function GetByte(pdu, index)
	{
		var str = pdu.substr(index, 2);
		var rval = parseInt(str, 16);
		return rval;
	}

	function clearListBox(listboxID)
 	{
  		var mylistbox = document.getElementById(listboxID);
  		if(mylistbox == null)
		{
  			return 1;
		}
  		while(mylistbox.length > 0)
  		{
   			mylistbox.remove(0);
  		}
  		return 1;
 	}

	function changetxt()
	{
		var s = document.getElementById("smsList").value;
		selectline = s;
		document.getElementById('message').innerHTML=ttext[s];
	}

	function sendsms()
	{
		if ( reading > 0 )
		{
			return false;
		}
		var s = document.getElementById("sendto").value;
		//document.getElementById('rding').innerHTML=s.length;
		if ( s.length == 0 )
		{
			alert("You must enter a phone number!!");
			return false;
		}
		s = s.trim();
		if ( isNaN(s) == true )
		{
			alert("Invalid phone number!!");
			return false;
		}
		var num = s.concat("                    ");
		num = num.substr(0, 20);
		var t = document.getElementById("txtmessage").value;
		if ( t.length == 0 )
		{
			alert("Message is blank!!");
			return false;
		}
		if ( t.length > 160 )
		{
			t = t.substr(0, 160);
		}
		num = num.concat(t);
		XHR.get('<%=luci.dispatcher.build_url("admin", "modem", "send_sms")%>',
			{ set: num },
			function()
			{
				alert("Message sent");
			}
		); 
	}

	function delsms()
	{
		if ( reading > 0 )
		{
			return false;
		}
		if ( selectline == -1 )
		{
			return false;
		}
		var r=confirm("Delete the selected message?");
		if (r==false)
  		{
  			return false;
  		}
		var s = document.getElementById("smsList").value;
		var dx = index[s];
		dx = dx + 1;
		XHR.get('<%=luci.dispatcher.build_url("admin", "modem", "del_sms")%>',
			{ set: dx },
			function()
			{
				clearListBox("smsList");
				document.getElementById('message').innerHTML="";
				alert("Message will be deleted.\nIt may take some time before the list is updated.");
			}
		); 
	}

	function replysms()
	{
		if ( reading > 0 )
		{
			return false;
		}
		var s = document.getElementById("smsList").value;
		if ( selectline == -1 )
		{
			return false;
		}
		else
		{
			document.getElementById('sendmsg').style.display="table";
			document.getElementById('sendtxt').style.display="table";
			document.getElementById('sendbtn').style.display="table";
			document.getElementById('sendtitle').style.display="block";
			document.getElementById("sendto").value=number[s];
			document.getElementById("txtmessage").value="";
		}
		return false;
	}

	function newsms()
	{
		if ( reading > 0 )
		{
			return false;
		}
		document.getElementById('sendmsg').style.display="table";
		document.getElementById('sendtxt').style.display="table";
		document.getElementById('sendbtn').style.display="table";
		document.getElementById('sendtitle').style.display="block";
		document.getElementById("sendto").value="";
		document.getElementById("txtmessage").value="";
		return false;
	}

//]]></script>

<form method="post" action="<%=REQUEST_URI%>">
<div class="cbi-map" id="cbi-sms">
<h2><a id="content" name="content">SMS Messaging</a></h2>
<div class="cbi-map-descr">Send and Receive Text Messages Through Your Modem</div>
<fieldset class="cbi-section" id="cbi-read">
	<legend>Received Messages</legend>

	<table width="550"  border="0">
  	<tr>
    		<td width="18%"><div align="center"><strong><u>Total Message Slots</u></strong></div></td>
    		<td width="18%"><div align="center"><strong><u>Used Message Slots</u></strong></div></td>
		<td width="64%">&nbsp;</td>
  	</tr>
  	<tr>
    		<td><div align="center"><ul id="total"></ul></div></td>
    		<td><div align="center"><ul id="used"></ul></div></td>
		<td>&nbsp;</td>
  	</tr>
	</table>

	<table width="700"  border="0">
  	<tr>
    		<td width="5%"><div align="center"><strong><u>Read</u></strong></div></td>
    		<td width="11%"><div align="center"><strong><u>Sender</u></strong></div></td>
    		<td width="9%"><div align="center"><strong><u>Date</u></strong></div></td>
    		<td width="10%"><div align="center"><strong><u>Time</u></strong></div></td>
    		<td width="20%"><div align="center"><strong><u>Message</u></strong></div></td>
    		<td width="45%"><div align="left"> </div></td>

	</tr>
	</table>

	<table width="700"  border="0">
  	<tr>
    		<td width="100%">
		<select name="smslist" id="smsList" size="5" style="width: 700px; font-size:15px; font-family:monospace; line-height:27px; float:left; height:130px;" onchange="changetxt()">
        	</select>
		</td>
	</tr>
	</table>

	<table width="550"  border="0">
  	<tr>
    		<td width="15%"><div align="left"><strong>Message :</strong></div></td>
    		<td width="70%"><ul id="message"></ul></td>
    		<td width="15%">&nbsp;</td>
  	</tr>
	</table>

	<table width="550"  border="0">
	<tr>
    		<td width="17%"><input type="button" id="delbtn" class="cbi-button cbi-button-apply" value="<%:Delete Message%>" onclick="return delsms()" /></td>
		<td width="17%"><input type="button" id="replybtn" class="cbi-button cbi-button-apply" value="<%:Reply to Message%>" onclick="return replysms()" /></td>
		<td width="17%"><input type="button" id="newbtn" class="cbi-button cbi-button-apply" value="<%:New Message%>" onclick="return newsms()" /></td>
    		<td width="49%">&nbsp;</td>
  	</tr>
	</table>

	<legend id="sendtitle" style="display:block;">Send Messages</legend>

	<table id="sendmsg" width="600"  border="0" style="display:table;">
  	<tr>
    		<td width="15%"><div align="left"><strong>Send To :</strong></div></td>
    		<td width="70%"><input type="number" name="sendto" id="sendto" maxlength="20"></input></td>
    		<td width="15%">&nbsp;</td>
  	</tr>
	</table>

	<table id="sendtxt" width="700"  border="0" style="display:table;">
  	<tr>
    		<td width="100%">
		<textarea name="txtmessage" id="txtmessage" rows="6" style="width: 600px;" maxlength="160"></textarea> 
		</td>
	</tr>
	</table>

	<table id="sendbtn" width="550"  border="0" style="display:table;">
	<tr>
    		<td width="17%"><input type="button" id="sendbtn" class="cbi-button cbi-button-apply" value="<%:Send%>" onclick="return sendsms()" /></td>
		<td width="13%">&nbsp;</td>
    		<td width="70%">&nbsp;</td>
  	</tr>
	</table>

</fieldset>

</div>
</form>
<%+footer%>